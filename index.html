<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园地图</title>
    <style>
        #map-container {
            position: relative;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        #map {
            width: 100%;
            height: 0;
            padding-top: 53.58%; /* (1378 / 2572) * 100 to maintain aspect ratio */
            background-image: url('Map.png'); 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <h1>校园地图，刷新以当前位置显示</h1>
    <div id="map-container">
        <div id="map"></div>
        <div class="marker" id="marker"></div>
    </div>

    <script>
        // Affine transformation coefficients
        const a = 0.000005353;
        const b = -0.000000725;
        const c = 121.159603;
        const d = -0.000000135;
        const e = -0.000004959;
        const f = 31.490984;

        // Image dimensions
        const imageWidth = 2572;
        const imageHeight = 1378;

        function lonLatToPixel(lon, lat) {
            // Inverse of the affine transformation
            const x = (lon - c - b * (lat - f) / e) / (a - b * d / e);
            const y = (lat - f - d * x) / e;
            return { x, y };
        }

        function showPosition(position) {
            const lon = position.coords.longitude;
            const lat = position.coords.latitude;
            
            const pixel = lonLatToPixel(lon, lat);
            const marker = document.getElementById('marker');
            
            // Convert pixel coordinates to percentages
            const xPercent = (pixel.x / imageWidth) * 100;
            const yPercent = (pixel.y / imageHeight) * 100;
            
            marker.style.left = xPercent + '%';
            marker.style.top = yPercent + '%';
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("用户拒绝了请求地理定位。");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("位置信息不可用。");
                    break;
                case error.TIMEOUT:
                    alert("请求超时。");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("发生未知错误。");
                    break;
            }
        }

        // Test
         /*
        const testPosition = {
            coords: {
                longitude: 121.165288,
                latitude: 31.486200
            }
        };
        showPosition(testPosition);
        */

        // 生产

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("该浏览器不支持定位。");
        }
        
    </script>
</body>
</html>
